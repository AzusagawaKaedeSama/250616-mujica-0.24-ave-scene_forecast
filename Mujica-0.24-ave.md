版本内容

---
系统名称：mujica-0.24-ave
MUJICA Forecasting System
Modular Unified Joint Interval & Confidence-aware Forecasting System. 
自律分散联合区间与置信感知预测系统

---
github发布页
https://github.com/AzusagawaKaedeSama/250616-mujica-0.24-ave-scene_forecast
本文未直接提供的内容在github发布页均可找到

---
功能概述
我们搭建了一个具有天气数据感知能力的多源数据融合的预测系统，可以预测负荷、光伏、风电出力，具备多种预测模式和不确定性建模能力。模型采用深度学习模型，项目系统目前包含数据处理，特征编码，峰谷感知，并且可以启用天气数据辅助预测，用户只需配置模型参数，点击按钮就可以进行预测和训练，预测功能包括日前滚动和区间预测（可以量化一定置信度的不确定性），用户配置参数包括预测间隔，预测日期范围，预测的地理区域等，系统还会对预测结果进行场景匹配和不确定性来源分析。
功能介绍
1.区间预测
区间预测结果不确定性表征+量化指标，以上海为例
冬季温和场景：1月普通的温和场景
[图片]
[图片]
[图片]
夏季高负荷场景：8月典型夏季场景分析
[图片]
[图片]

[图片]
冬季负荷场景：12月典型供暖用能负荷场景
[图片]
[图片]
[图片]
春季新能源大发场景：4月
[图片]
[图片]
[图片]
2.不确定性来源分析
天气场景分析与不确定性来源分析。以上海8月23日为例
[图片]
3.高峰感知负荷日前预测
以上海为例。
[图片]
[图片]
4.天气感知日前预测
以江苏为例
[图片]
5.确定性滚动预测
[图片]
可以选择启动天气感知、和PID误差修正。但两者目前不能同时启用
[图片]
6.训练过程监控
[图片]
目前只能一个一个的训练模型，因为一键训练所有模型当前最小的batch size都会爆内存。
[图片]
7.历史结果查询
[图片]
直接给出已进行预测的某种特定预测方式、确定的模型类型的预测结果。
8.（待添加功能）
8.1概率预测
本来是想做一个多分位数的概率预测，目前还未实现
[图片]
8.2场景识别
该功能已被区间预测的天气感知合并，后续该页面可能改为场景识别与风险对冲策略分析
[图片]
系统使用指南

---
以下指南面向系统开发者和运营者
1. 配置环境
  1. 安装python
  2. 配置好必要的python库
2. 数据准备
  1. 目前数据源为csv文件，无需特别配置
3. 模型训练
  1. 进入界面：在用户交互的前端平台页面（后称“平台界面”）的训练页面训练模型
  2. 配置参数：要完成系统的所有功能需要训练某个省份的电力负荷、光伏发电、风电出力三种天气感知的模型，以下是参数配置参考。简单来说按照用户只需要配置预测类型、省份以及日期范围，其他按照默认值即可。
    1. 预测类型：电力负荷/光伏发电/风电出力
    2. 省份：如上海
    3. 训练开始日期/结束日期：如2024/01/01--2024/08/31
    4. 训练轮数：建议按默认值100
    5. 批处理大小：建议按默认值32
    6. 学习率：建议按默认值0.001
    7. 历史数据天数：建议按默认值
    8. 训练目标类型：建议按默认值，确定性预测
    9. 重新训练：无需勾选
    10. 启用天气感知训练/启用峰谷感知：可以勾选，只能勾选一个，建议勾选天气感知
[图片]
  3. 开始训练：点击红色的训练模型按钮。在训练状态卡片可以看到当前的轮次。通常15~25轮就会结束，大约花费5分钟完成一个模型的训练。完成训练后训练状态会变为绿色。
[图片]
4. 预测
  1. 完成某个省份的三个模型的训练后，可以自由的进行日前预测、滚动预测和区间预测。
  2. 日前预测：以电力负荷天气感知的日前预测为例
    1. 模型仅获取历史数据（包括负荷真实值、时间、天气真实值等特征）、待预测时间范围影响因素数据（只包括天气、节假日等特征）
    2. 单步预测，逐步递归地预测出用户设定的时间范围内的负荷结果。
    3. 不会获取待预测时间范围内的真实的负荷数据。
  3. 滚动预测A：以电力负荷天气感知的滚动预测为例
    1. 模型获取历史数据（包括负荷真实值、时间、天气真实值等特征）、待预测时间范围影响因素数据（只包括天气、节假日等特征）。随着时间的推移，会不断获知待预测时间范围内的真实负荷数据，并将其作为历史负荷数据输入模型。
    2. 单步预测，逐步地获取已经过的时间点的真实负荷，并纳入模型输入，预测出用户设定的时间范围内的负荷结果。
  4. 滚动预测B：以电力负荷天气感知的PID误差修正预测为例
    1. 模型获取历史数据（包括负荷真实值、时间、天气真实值等特征）、待预测时间范围影响因素数据（仅包括节假日等时间特征）。随着时间的推移，会不断获知待预测时间范围内的真实负荷数据，并将其作为历史负荷数据输入模型。同时会根据真实的负荷数据和此前的预测结果计算预测误差
    2. 单步预测，逐步地获取已经过的时间点的真实负荷，并纳入模型输入，预测出用户设定的时间范围内的初步的负荷预测结果。
    3. 通过收集的预测误差序列调整PID参数，并将初步的负荷预测结果经过比例、微分、积分的修正，得到最终的负荷预测结果。
  5. 区间预测：以电力负荷的可再生能源增强区间日前预测为例
    1. 模型获取历史数据（包括负荷真实值、负荷预测值、时间、天气真实值等特征）、待预测时间范围影响因素数据（包括天气、节假日等特征）。通过历史负荷预测精度收集误差序列，利用误差序列计算一定置信度下的最佳的区间宽度比例。
    2. 单步预测，逐步递归地预测出用户设定时间范围内的光伏、风电均值。
    3. 通过可再生能源出力情况以及天气情况调整预测区间宽度。
    4. 单步预测，逐步递归地预测出用户设定时间范围内的负荷均值，通过区间宽度进一步计算一定置信度下的负荷概率区间上下界。
  6. 目前无法使用的功能：
    1. 滚动预测的实时校正（简单）的勾选（该方法还未维护）
    2. 多分位数的概率预测（目前只能进行单个分位数的预测，也就是区间预测，区间预测选择的置信度本质上就是分位数，比如你选择的90%置信度的结果就是0.05分位数和0.95分位数结果的差值）
    3. 历史结果查询（没有文件是查不到的）
    4. 场景识别（目前识别的场景结果有误）
面向用户的使用指南
多源电力预测与调度平台 用户使用指南
系统部署与迁移方法
如果你想了解更详细的关于anaconda、cuda和cudnn以及nodejs的安装与环境配置步骤，可前往科研工具（楷铭）相关章节
硬件要求
- 显卡：NVIDIA RTX 4060
- 操作系统：Windows 10 64位
- 内存：16G（推荐32G）
环境配置要求
- CUDA版本：11.8
- cudnn版本：8.8.0
- python版本：3.10+
- python依赖：提供requirements.txt
- 前端依赖：安装nodejs与npm
- 特别注意torch需要单独安装GPU的+cu118版本（在对应环境的prompt中运行下面的命令）
pip install torch==2.6.0+cu118 torchvision==0.21.0+cu118 torchaudio==2.6.0+cu118 --index-url https://download.pytorch.org/whl/cu118
系统架构
1.整体架构思路
本系统采用简单的两层架构设计：
- 前端视图层：负责用户交互和结果展示
- 后端控制器与模型层：负责业务逻辑处理和数据建模
2.架构示意图
┌─────────────────────────────────────────────────────────────┐
│                    前端视图层 (Frontend)                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   用户界面层     │  │   交互控制层     │  │   数据展示层  │ │
│  │  (UI Components)│  │  (Event Handlers)│  │ (Visualization)│ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │ HTTP API
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  后端控制器与模型层 (Backend)                  │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   控制器模块                             │ │
│  │  ┌─────────────┐  ┌────────────────────────────────────┐│ │
│  │  │ Flask API   │  │      集成调度脚本                   ││ │
│  │  │ (app.py)    │  │  (scripts/scene_forecasting.py)    ││ │
│  │  └─────────────┘  └────────────────────────────────────┘│ │
│  └─────────────────────────────────────────────────────────┘ │
│                              │                               │
│                              ▼                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                     模型模块                             │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────┐ │ │
│  │  │ 数据预处理    │ │ 数据管理      │ │ 模型构建与训练    │  │ │
│  │  │ 模块          │ │ 模块         │ │ 模块             │  │ │
│  │  └──────────────┘ └──────────────┘ └──────────────────┘  │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────┐  │ │
│  │  │ 预测执行      │ │ 场景分析      │ │ 文件系统存储      │  │ │
│  │  │ 模块          │ │ 模块          │ │ 模块            │  │ │
│  │  └──────────────┘ └──────────────┘ └──────────────────┘  │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
3.视图层架构
frontend/
├── public/                    # 静态资源
│   ├── index.html            # HTML入口文件
│   └── fonts/                # 字体文件
├── src/                      # 源代码
│   ├── app.jsx              # 主应用组件
│   ├── main.jsx             # 应用入口
│   ├── components/          # React组件
│   │   ├── Header.jsx       # 页面头部组件
│   │   ├── ParameterSettings.jsx    # 参数配置组件
│   │   ├── RollingSettings.jsx      # 滚动预测设置
│   │   ├── IntervalSettings.jsx     # 区间预测设置
│   │   ├── TrainingSettings.jsx     # 训练设置组件
│   │   ├── MetricsCard.jsx          # 指标卡片组件
│   │   ├── HistoricalResultsTab.jsx # 历史结果查看
│   │   └── ScenarioAwareUncertaintyForecast.jsx # 场景感知预测
│   ├── styles/              # 样式文件
│   └── utils/               # 工具函数
│       ├── api.js           # API封装
│       ├── chartRenderers.js # 图表渲染
│       └── formatters.js    # 数据格式化
├── package.json             # 依赖配置
├── vite.config.js          # Vite配置
└── tailwind.config.js      # TailwindCSS配置
前端视图层位于frontend文件夹，主要包括主页面、页面内容、页面样式等内容，基于html+js+css编程，主要以react组件搭建。
3.3 核心组件模块

3.3.1 用户界面层 (UI Components)

主应用组件 (app.jsx)
输入：用户交互事件、路由参数
输出：渲染的页面DOM结构
主要功能：
- 应用状态管理
- 路由控制
- 全局主题管理
- 组件协调

参数配置组件 (ParameterSettings.jsx)
输入：默认参数配置、用户选择事件
输出：参数配置对象、状态变更事件
主要功能：
- 省份选择控制
- 预测类型选择
- 日期范围设置
- 历史数据天数配置
- 置信水平设置

预测设置组件群
RollingSettings.jsx：滚动预测参数设置
IntervalSettings.jsx：区间预测参数设置
TrainingSettings.jsx：模型训练参数设置
输入：用户配置操作、默认参数
输出：特定类型的参数配置对象
主要功能：专门化的参数配置界面

3.3.2 交互控制层 (Event Handlers)

API交互模块 (utils/api.js)
输入：前端请求参数、配置对象
输出：后端响应数据、错误信息
主要功能：
- HTTP请求封装
- 错误处理
- 请求超时控制
- 响应数据格式化

事件处理器
输入：用户交互事件（点击、输入、选择）
输出：状态更新、API调用、页面跳转
主要功能：
- 表单提交处理
- 参数验证
- 异步操作管理
- 用户反馈显示

3.3.3 数据展示层 (Visualization)

指标卡片组件 (MetricsCard.jsx)
输入：预测结果数据、指标配置
输出：可视化图表、数据表格
主要功能：
- 预测精度指标展示
- 时间序列图表渲染
- 区间预测可视化
- 不确定性分析展示

图表渲染模块 (utils/chartRenderers.js)
输入：原始数据、图表配置
输出：Chart.js/ECharts配置对象
主要功能：
- 时间序列图表配置
- 区间预测阴影区域
- 多系列数据对比
- 交互式图表功能

3.4 用户交互流程

用户操作 → 参数配置 → 事件触发 → API调用 → 数据处理 → 结果展示
    ↓         ↓         ↓         ↓         ↓         ↓
 选择省份   设置参数   点击预测   发送请求   格式化数据  渲染图表
 选择类型   验证输入   提交表单   等待响应   错误处理   显示指标
 设置日期   状态更新   加载状态   解析JSON   缓存结果   用户反馈

4.控制器与模型层架构
后端控制器与模型层较为混乱和复杂。模型模块主要包括数据预处理（data_preprocess, scripts/data_preparation）、数据/数据读写/数据特征编码/数据集构建（data）、存储的模型/模型构建（models）、训练不同模型（scripts/train）、进行各种类型的预测（scripts/forecast）（scripts/analysis）
控制器模块也位于后端，但是作为一个桥梁联系模型模块和前端视图层，但是界限较为模糊。主要包括app.py(flask), scripts/scene_forecasting.py（模块调用集成脚本）

---
4.1 控制器模块

4.1.1 Flask API服务 (app.py)

基础架构
输入：HTTP请求（JSON格式参数）
输出：HTTP响应（JSON格式结果）
主要功能：
- RESTful API端点管理
- 请求参数验证
- 跨域请求处理（CORS）
- 缓存管理
- 错误处理和日志记录

核心API端点

端点路径
方法
输入参数
输出数据
功能描述
/api/predict
POST
province, forecastType, forecastDate, historicalDays
预测结果JSON
普通预测
/api/weather-forecast
POST
province, forecastDate, weatherAware=true
天气感知预测结果
天气感知预测
/api/interval-forecast
POST
province, forecastType, startDate, endDate, confidenceLevel
区间预测结果
区间预测
/api/train
POST
province, forecastType, trainStart, trainEnd
训练任务ID
模型训练
/api/provinces
GET
无
省份列表
获取支持省份
/api/historical-results
GET
modelType, predictionType, province
历史结果列表
历史结果查询

缓存管理系统
输入：请求参数哈希值、缓存策略配置
输出：缓存命中结果或新计算结果
主要功能：
- 智能缓存键生成
- 分类型缓存时间控制
- 缓存命中统计
- 强制刷新机制

任务管理系统
输入：异步任务请求、任务配置参数
输出：任务状态、执行结果
主要功能：
- 训练任务队列管理
- 任务状态跟踪
- 超时处理
- 进程监控

4.1.2 集成调度脚本 (scripts/scene_forecasting.py)

核心功能
输入：命令行参数、配置文件
输出：预测结果文件、执行日志
主要功能：
- 统一的预测入口
- 多模块协调调度
- 参数解析和验证
- 结果文件管理

命令行接口
python scripts/scene_forecasting.py \
    --mode forecast \
    --province 上海 \
    --forecast_type load \
    --forecast_date 2024-06-10 \
    --day_ahead \
    --weather_aware

参数处理模块
输入：命令行参数字符串
输出：结构化参数对象
主要功能：
- 参数解析和类型转换
- 默认值设置
- 参数冲突检测
- 路径规范化

4.2 模型模块

4.2.1 数据预处理模块

目录结构
data_preprocess/
├── process_weather_data.py      # 天气数据处理
├── process_all_data.py          # 批量数据处理
└── 各省份天气数据目录/
    └── 月度NC文件

天气数据处理 (data_preprocess/)
输入：NC格式气象文件、Excel格式负荷数据
输出：标准化CSV时间序列文件
主要功能：
- NetCDF文件解析
- 多气象要素提取（温度、湿度、风速、降水）
- 区域网格数据聚合
- 时间序列插值和对齐

数据准备脚本 (scripts/data_preparation/)
输入：原始数据文件、处理配置
输出：训练就绪的数据集
主要功能：
- 天气-负荷数据融合
- 可再生能源数据处理
- 数据质量检查和清洗

4.2.2 数据管理模块 (data/)

数据加载器 (data_loader.py)
输入：数据文件路径、加载配置
输出：Pandas DataFrame对象
主要功能：
- 多格式数据文件读取
- 数据类型自动识别
- 缺失值处理
- 数据范围验证

数据集构建器 (dataset_builder.py)
输入：原始时间序列数据、特征工程配置
输出：训练/测试数据集
主要功能：
- 时间窗口切分
- 特征工程（滞后特征、时间特征、峰谷特征）
- 数据标准化
- 训练/验证/测试集划分

数据文件组织
data/
├── timeseries_load_*.csv        # 负荷数据
├── timeseries_pv_*.csv          # 光伏数据
├── timeseries_wind_*.csv        # 风电数据
├── timeseries_*_weather_*.csv   # 天气感知数据
└── *.db                         # SQLite数据库文件

4.2.3 模型构建与训练模块 (models/)

深度学习模型 (torch_models.py)
输入：模型配置参数、训练数据
输出：训练好的PyTorch模型
主要功能：
- ConvTransformer架构实现
- 多头注意力机制
- 残差连接和层归一化
- 自定义损失函数

天气增强模型 (weather_enhanced_model.py)
输入：负荷数据 + 天气特征数据
输出：天气感知预测模型
主要功能：
- 多模态特征融合
- 天气场景编码
- 动态权重调整
- 不确定性量化

统计模型 (statistical_models.py)
输入：时间序列数据、模型参数
输出：统计预测模型
主要功能：
- ARIMA模型实现
- 指数平滑模型
- 季节性分解
- 趋势分析

训练脚本 (scripts/train/)
scripts/train/
├── train_keras.py              # Keras模型训练
├── train_interval.py           # 区间预测模型训练
├── train_probabilistic.py     # 概率预测模型训练
└── train_weather_enhanced.py  # 天气增强模型训练

4.2.4 预测执行模块 (scripts/forecast/)

预测脚本组织
scripts/forecast/
├── day_ahead_forecast.py                    # 日前预测
├── interval_forecast_fixed.py              # 区间预测
├── probabilistic_forecast.py               # 概率预测
├── scenario_aware_uncertainty_forecast.py  # 场景感知预测
└── weather_aware_forecast.py               # 天气感知预测

日前预测 (day_ahead_forecast.py)
输入：历史数据、预测日期、模型文件
输出：24小时点预测结果
主要功能：
- 模型加载和初始化
- 输入数据预处理
- 预测执行和后处理
- 结果格式化和保存

区间预测 (interval_forecast_fixed.py)
输入：历史数据、置信水平、预测范围
输出：带置信区间的预测结果
主要功能：
- 分位数回归模型
- 不确定性量化
- 置信区间计算
- 区间覆盖率验证

场景感知预测 (scenario_aware_uncertainty_forecast.py)
输入：天气预报数据、历史场景库
输出：场景分析 + 动态不确定性预测
主要功能：
- 天气场景识别（17种场景）
- 动态不确定性调整
- 场景匹配和相似度计算
- 详细解释生成

4.2.5 场景分析模块 (scripts/analysis/)

天气场景聚类 (weather_scenario_clustering.py)
输入：全年天气-负荷数据
输出：场景聚类结果、典型场景识别
主要功能：
- K-means聚类分析
- 多维特征分析
- 典型场景日识别
- 极端天气统计

场景汇总生成 (generate_scenario_summary.py)
输入：各省份场景分析结果
输出：区域汇总报告、Excel数据表
主要功能：
- 跨省份数据汇总
- 统计指标计算
- 可视化图表生成
- 运行建议生成

4.2.6 文件系统存储模块

模型文件存储
models/
├── convtrans_weather/          # 天气感知模型
│   ├── load/省份/             # 负荷预测模型
│   ├── pv/省份/               # 光伏预测模型
│   └── wind/省份/             # 风电预测模型
├── convtrans_peak/            # 峰谷感知模型
└── scalers/                   # 数据标准化器

结果文件存储
results/
├── day_ahead/                 # 日前预测结果
├── weather_aware_day_ahead/   # 天气感知预测结果
├── interval_forecast/         # 区间预测结果
├── probabilistic/             # 概率预测结果
└── analysis/                  # 分析结果

存储接口
输入：结果数据对象、存储路径配置
输出：文件保存状态、访问路径
主要功能：
- JSON/CSV格式转换
- 目录结构管理
- 文件命名规范
- 历史版本管理

5.数据流转和交互模式
5.1 典型预测流程
1. 前端参数配置
   ├── 用户选择省份、预测类型、日期
   ├── 设置历史数据天数、置信水平
   └── 提交预测请求

2. API请求处理
   ├── Flask接收POST请求
   ├── 参数验证和缓存检查
   ├── 构建命令行参数
   └── 调用scene_forecasting.py

3. 集成脚本执行
   ├── 参数解析和路径构建
   ├── 数据加载和预处理
   ├── 模型加载和预测执行
   └── 结果保存和日志记录

4. 结果返回处理
   ├── 读取预测结果文件
   ├── 数据格式转换（CSV→JSON）
   ├── 添加元数据和统计信息
   └── HTTP响应返回

5. 前端结果展示
   ├── 解析响应数据
   ├── 生成图表配置
   ├── 渲染可视化组件
   └── 显示指标和分析

5.2 训练流程
1. 训练任务提交
   ├── 前端配置训练参数
   ├── API创建异步任务
   └── 返回任务ID

2. 后台训练执行
   ├── 数据准备和特征工程
   ├── 模型构建和参数初始化
   ├── 训练循环和验证
   └── 模型保存和评估

3. 状态监控
   ├── 定期查询训练状态
   ├── 更新进度和日志
   └── 完成通知

5.3 缓存机制
请求 → 缓存键生成 → 缓存查找 → 命中/未命中
  ↓         ↓         ↓         ↓
参数哈希   MD5计算   内存查询   返回结果/执行计算
配置合并   键前缀    过期检查   更新缓存

6.系统边界和限制
6.1 模块边界问题
控制器与模型层界限模糊
- app.py既承担API控制又包含业务逻辑
- scene_forecasting.py作为集成脚本承担了过多职责
- 数据处理逻辑分散在多个模块中

数据访问层缺失
- 直接文件系统读写，缺乏统一的数据访问接口
- 数据格式转换逻辑散布在各个模块
- 缺乏数据一致性和事务管理

6.2 可维护性问题

代码耦合度高
- 前端直接调用后端脚本，缺乏抽象层
- 模型训练和预测逻辑混合
- 配置管理分散，难以统一维护

扩展性限制
- 新增预测类型需要修改多个模块
- 模型替换困难，接口不统一
- 缺乏插件化架构支持

6.3 技术债务

性能问题
- 同步处理模式，长时间任务阻塞
- 缓存策略简单，命中率有待提升
- 文件I/O操作频繁，缺乏优化

稳定性问题
- 错误处理不完善，异常传播链条长
- 资源管理不当，可能存在内存泄漏
- 中文路径兼容性问题

---

readme记录了此前系统的主要功能，log文件记录了系统主要的更新记录。

本版本研究思路与动机
整体建模思路：对于一个区域的预测结果，我们特别引入了天气场景感知的动态不确定性建模，能够根据具体的天气场景动态调整不确定性表征，为用户提供更准确的预测区间和详细的不确定性分析。
输入数据：因此，只要我们得到了历史的各省加和的确切的净负荷结果，历史的各省加和净负荷的预测结果（可用于计算预测偏差），历史的天气情况，待预测时间段的天气情况。我们就可以利用这些数据，预测得到待预测时间段的净负荷结果以及它的不确定性表征。
不确定性建模：
不确定性主要可以分为认知不确定性（模型系统误差）和固有不确定性。我们的目的就是要让表征出来的不确定性尽量是事物固有的不确定性，而不是认知不确定性。
多个模型的预测可以忽略模型系统误差的影响。我们认为预测结果虽然未必准确，但只需要让预测结果的分布能够覆盖负荷就可以，不用考虑负荷本身是什么分布。
我们将得到的预测误差视为负荷的变化偏差，由预测误差序列生成的预测区间在数学上能被证明是一定置信水平下对负荷概率分布比较准确的近似。将预测误差进行升序排序，得到预测误差序列（预测误差序列长度为预测的滑动窗口长度）。之后根据置信水平1-alpha，在0~alpha区间计算最优的参数beta，使得利用误差序列生成的区间宽度最小。之后利用确定性预测的结果和预测误差序列的beta分位数和1-alpha+beta分位数生成预测区间的下界和上界。
动态不确定性：在滚动预测和以及日前预测中都能够通过预测误差序列的更新，动态改变区间宽度。
完整技术流程详解
我们的技术流程步骤包括数据清洗、特征工程、归一化、构建划分数据集、模型选取、模型训练、模型参数调整、模型预测、结果表征。
[图片]
[图片]
1. 数据清洗阶段
根据代码分析，数据清洗主要在 DatasetBuilder 类中进行：
时间序列数据标准化（datetime列处理）
缺失值处理和异常值检测
数据完整性验证
时间间隔一致性检查

2. 特征工程阶段
时间特征
- 基础时间：年、月、日、小时、分钟
- 周期特征：星期几、是否工作日、是否节假日
- 季节特征：春夏秋冬季节标识
- 峰谷感知特征：高峰时段(8:00-20:00)、低谷时段(0:00-6:00)
天气特征
- 温度特征：当前温度、温度变化率
- 湿度特征：相对湿度、湿度变化趋势
- 风力特征：风速、风向
- 降水特征：累积降水
- 辐射特征：太阳辐射强度
负荷历史特征
- 滞后特征：1-7天同时刻历史负荷
- 移动平均：3天、7天、30天移动平均
- 波动特征：负荷标准差、变异系数
- 趋势特征：负荷增长率、季节性调整

3. 归一化处理
ScalerManager归一化实现：
- 使用 StandardScaler 对特征和目标进行Z-Score标准化
- 分别对X和y进行标准化，保证数值稳定性
- 支持正向和反向标准化
def fit_scalers(self, X_train, y_train):
    # 对输入特征X和目标变量y分别进行标准化
    # 支持不同的缩放方法（StandardScaler, MinMaxScaler等）
4. 数据集构建和划分
def prepare_data_for_train(self, ts_data, test_ratio=0.2, model_type='torch', add_features=False, value_column='load'):
    # 构建训练集、验证集、测试集
    # 时间序列数据的序列化处理（seq_length=96，即24小时数据）
5. 模型选择
使用天气数据时采用的是 WeatherAwareConvTransformer 模型：
class WeatherAwareConvTransformer(PeakAwareConvTransformer):
    """基于PeakAwareConvTransformer的天气增强模型
    保持原有的高精度架构，增加天气特征处理能力"""

模型架构特点：
- 卷积层：捕获局部时间模式
- Transformer编码器：处理长期依赖关系
- 天气特征编码器：专门处理天气信息
- 峰谷感知机制：对高峰和低谷时段进行差异化建模

6. 模型训练
训练方法是 train_weather_aware_model：
def train_weather_aware_model(data_path, train_start_date, train_end_date, 
                             forecast_type='load',
                             weather_features=None, ...):

训练流程：
- 加载包含天气数据的时间序列
- 自动识别或手动指定天气特征
- 使用峰谷感知的数据准备方法
- 创建天气感知模型并训练
- 保存模型和标准化器

模型训练特色：
1. 峰值感知损失函数：高峰时段权重5.0，低谷时段权重1.5
2. AdamW优化器：权重衰减1e-4，提高泛化能力
3. 余弦退火学习率调度：逐步降低学习率
4. 早停机制：防止过拟合
5. 梯度裁剪：避免梯度爆炸

7. 模型参数调整
通过 convtrans_config 进行参数配置：
convtrans_config = {
    'seq_length': 96,        # 输入序列长度（24小时×4点/小时）
    'pred_length': 1,        # 预测长度
    'batch_size': 32,        # 批次大小
    'lr': 1e-4,              # 学习率
    'epochs': 50,            # 训练轮数
    'patience': 10,          # 早停耐心值
    'peak_weight': 10,       # 高峰时段权重
    'valley_weight': 1.5     # 低谷时段权重
}

参数调整策略：
1. 动态批量大小优化：根据显存自动调整批量大小
2. 余弦退火学习率：预热+退火，从高学习率逐步降低
3. 组合损失函数：MSE + MAPE组合，权重0.7:0.3
4. 混合精度训练：加速训练并减少显存占用
5. 自适应优化器：AdamW + 权重衰减

8. 模型预测 天气感知区间预测
预测方法是 perform_weather_aware_interval_forecast_for_range，预测流程分为三个步骤：
收集历史误差、通过误差序列构造最优区间宽度，由点预测结果生成设定置信概率下的自适应区间
def perform_weather_aware_interval_forecast_for_range(...):
    """为指定日期范围执行天气感知区间预测"""
步骤1：历史误差收集
def get_historical_prediction_errors(province, forecast_type, history_start_date, history_end_date):
    # 使用历史预测数据计算预测误差
    # 收集足够多的误差样本用于构建误差分布
步骤2：最优区间宽度寻找
def find_optimal_beta(sorted_errors, confidence_level):
    # 基于历史误差分布，寻找最优的区间参数β
    # 目标：在给定置信水平下最小化区间宽度
将预测误差进行升序排序，得到预测误差序列（预测误差序列长度为预测的滑动窗口长度）。之后根据置信水平1-alpha，在0~alpha区间计算最优的参数beta，使得利用误差序列生成的区间宽度最小。之后利用确定性预测的结果和预测误差序列的beta分位数和1-alpha+beta分位数生成预测区间的下界和上界。
步骤3：设定置信概率下自适应区间预测生成
def generate_weather_aware_interval_forecast(province, forecast_type, forecast_date, ...):
    # 使用天气感知模型进行点预测
    # 基于历史误差分布生成预测区间
在滚动预测和以及日前预测中都能够通过预测误差序列的更新，动态改变区间宽度。

---
模型预测特色：
1. 批量预测：减少模型加载次数，提高效率
2. 缓存机制：特征缓存避免重复计算
3. 异常处理：对无效预测使用备用值
4. 内存管理：分批处理避免显存溢出
5. 预测鲁棒性：多层检查确保预测值合理
9. 结果表征 JSON输出
在 scene_forecasting.py 中，最终结果以JSON格式输出：
if args.output_json and results_df is not None:
    output_data = {
        'status': "success",
        'forecast_type': args.forecast_type,
        'weather_aware': args.weather_aware,
        'weather_features': args.weather_features.split(','),
        'is_interval_forecast': args.train_prediction_type == 'interval',
        'predictions': results_json.to_dict(orient='records'),
        'interval_statistics': {...},
        'metrics': {...}
    }
结果包含：
- 点预测值：predicted, 未来24小时逐15分钟负荷预测
- 预测区间：lower_bound, upper_bound, 置信区间上下限
- 天气场景信息：weather_scenario
- 区间统计指标：平均区间宽度、区间命中率等
- 预测精度指标：MAE、RMSE、MAPE等

10.总结
1. 数据层面：融合历史负荷、天气数据，进行精细化特征工程
2. 模型层面：采用卷积+Transformer架构，专门处理天气特征
3. 训练层面：峰谷感知的差异化训练，提高关键时段精度
4. 预测层面：基于误差分布的区间预测，提供不确定性量化
5. 应用层面：支持多省份、多预测类型，输出标准化JSON结果


核心技术亮点
1. 峰值感知架构：专门针对电力负荷的高峰特性设计
2. 多源数据融合：历史负荷 + 天气 + 时间特征
3. 误差分布建模：基于历史误差的概率区间预测
4. 自适应置信度：动态调整区间宽度


技术细节解释
- 典型问题
1. 负荷预测的输入输出内容是什么？
2. 不确定度是怎么表征的。/负荷不确定度表征如何理解。
3. 这里的不确定度是由历史数据计算出来固定的还是由我们的预测日的天气计算得到进行分类的结果。
4. 这里的场景识别参数结果的含义是什么？
5. 这里为什么是这个场景，这里的置信度什么意思？场景信息是怎么算出来的。

1. 负荷预测的输入输出内容
必需输入数据
1. 历史负荷数据
  - 格式：CSV时间序列文件
  - 字段：datetime, load
  - 频率：15分钟间隔
  - 长度：至少30天历史数据
2. 天气数据
  - 格式：CSV时间序列文件
  - 字段：datetime, temperature, humidity, wind_speed, precipitation, radiation
  - 频率：15分钟或1小时间隔
  - 范围：历史数据+未来24小时预报
3. 新能源数据
  - 光伏出力历史和预测数据
  - 风电出力历史和预测数据
4. 特殊事件标识
  - 节假日标识
  - 特殊事件(如疫情、重大活动)
模型预测参数（可选，缺省则为默认参数）
  - 预测日期：YYYY-MM-DD格式
  - 预测类型：day_ahead(日前)、real_time(实时)
  - 置信水平：0.5~0.99（代表预期的实际结果落在预测区间的概率，也就是说区间覆盖率会很接近这个数值）
  - 预测事件间隔：最小15分钟，step=15min
  - 预测类型：净负荷、总负荷、新能源

---
以下为模型的输入内容：模型的输入由工具完成，在流程内部自动化实现
基础输入特征：
- 历史负荷序列：过去96个时间点（24小时×4个15分钟间隔）的负荷数据
- 时间特征：小时、星期几、月份、是否节假日等
- 峰谷特征：是否高峰时段（8:00-20:00）、是否低谷时段（0:00-6:00）
- 滞后特征：1、4、24、48、168个时间步的滞后负荷值
天气感知输入特征：
weather_features = [
    'temperature',        # 温度
    'humidity',          # 湿度  
    'pressure',          # 气压
    'wind_speed',        # 风速
    'wind_direction',    # 风向
    'precipitation',     # 降水量
    'solar_radiation'    # 太阳辐射
]
衍生天气特征：
- 制冷度日(CDD)和制热度日(HDD)
- 热指数（温度+湿度）
- 体感温度（考虑风速）
- 露点温度

---


输出内容：输出文件格式为json文件
output_data = {
        'status': "success",
        'forecast_type': args.forecast_type,
        'weather_aware': args.weather_aware,
        'weather_features': args.weather_features.split(','),
        'is_interval_forecast': args.train_prediction_type == 'interval',
        'predictions': results_json.to_dict(orient='records'),
        'interval_statistics': {...},
        'metrics': {...}
    }
确定性预测：
- 点预测值：未来时间点的负荷预测值
- 时间戳：对应的预测时间
不确定性预测：
- 场景预测：最接近的场景，该场景下的不确定性衡量方法。
- 区间预测：置信区间（下界、上界、置信水平），负荷均值


2. 输入不确定性的表征方式
系统中的不确定性主要来自：
A. 历史数据的自然变异性
# 通过滞后特征捕获历史变化模式
lag_features = ['load_lag_1', 'load_lag_4', 'load_lag_24', 'load_lag_48', 'load_lag_168']
B. 天气数据的变化
- 不是概率分布输入：系统使用的是确定性天气数据（温度、湿度等具体数值）
- 天气变化通过时间序列体现：通过连续的天气数据序列反映天气变化趋势
- 天气特征工程：计算温度变化率、24小时温差等反映变化特征
C. 模型结构捕获的不确定性
# 天气感知模型通过注意力机制融合天气和负荷特征
fused_features, _ = self.fusion_layer(
    query=load_transformed,
    key=weather_transformed, 
    value=weather_transformed
)

3. 动态不确定性表征方法
动态是针对多场景的动态，一旦确定了我们要预测的时间段，不确定性就确定了。

动态不确定性计算公式
最终不确定性 = 基础不确定性 × 场景不确定性倍数 × 时段调整系数 × 新能源不确定性调整 + 场景置信度
参数说明：
- 基础不确定性：由历史预测偏差确定得到最优的区间
- 场景不确定性倍数：0.8x-4.0x（根据多种场景动态调整）
- 时段调整系数：
  - 早晨(6:00-9:00)：1.2x
  - 中午(11:00-14:00)：0.9x
  - 晚高峰(18:00-21:00)：1.3x
  - 夜间(22:00-5:00)：1.1x
- 新能源不确定性调整：
  - 高风险等级：2.00x
  - 中风险等级：1.30x
  - 低风险等级：1.00x
- 场景置信度
  - 低置信度<0.3：+20%不确定性
  - 高置信度>0.7：-10%不确定性


识别场景分类体系
1. 极端天气场景(6种)
  - 极端暴雨：不确定性倍数3.5x
  - 极端高湿、极端高温：不确定性倍数3.0x
  - 极端大风：不确定性倍数2.8x
  - 特大暴雨：不确定性倍数4.0x
  - 极端寒冷：不确定性倍数3.0x
2. 普通天气变种(4种)
  - 春季温和、夏季舒适、秋季平稳、冬季温和
3. 基础场景(4种)
  - 大风晴朗、无风阴天、温和正常、小雨微风：


典型场景(用于匹配，计算场景置信度)
因为具体有可能和多种场景都很类似，置信度表示第一场景和第二场景相似度之差。
  - 一般正常场景：对应"一般场景"(占比33.3%)
  - 多雨低负荷：对应"多雨低负荷"(占比43.4%)
  - 温和高湿高负荷：对应"温和高湿高负荷"(占比23.2%)


4. 输出的不确定度表征
系统提供：
1. 统计指标
  - 平均绝对误差(MAE)：预测精度指标
  - 均方根误差(RMSE)：预测稳定性指标
  - 平均绝对百分比误差(MAPE)：相对误差指标
  - 相关系数：预测趋势一致性指标
2. 区间质量指标
  - 区间覆盖率：实际值落在预测区间内的比例
  - 平均区间宽度：不确定性大小的直观表征
  - 区间技能评分：综合考虑覆盖率和宽度的评分
3. 场景感知指标
  - 场景识别准确率：天气场景识别的正确率
  - 场景置信度：场景匹配的可信程度
  - 不确定性调整因子：动态调整的倍数
4. 风险评估指标
  - 系统风险等级：低、中、高、极高四级
  - 极端事件概率：负荷超过安全阈值的概率
  - 调度裕度建议：基于不确定性的备用容量建议

---
A. 区间预测输出
{
    "predictions": [
        {
            "datetime": "2024-01-01T00:00:00",
            "predicted": 25000.5,
            "lower_bound": 23500.2,
            "upper_bound": 26800.7,
            "confidence_level": 0.9
        }
    ]
}
B. 不确定性统计指标
{
    "interval_statistics": {
        "average_interval_width": 3200.5,
        "confidence_level": 0.9,
        "hit_rate": 92.5,
        "total_predictions": 96
    }
}
C. 场景识别输出
{
    "scenarios": [
        {
            "datetime": "2024-01-01T14:00:00",
            "scenario_type": "high_renewable_output",
            "confidence": 0.85,
            "load_scenario": "normal_demand",
            "weather_condition": "sunny_windy"
        }
    ]
}
具体建模过程：

