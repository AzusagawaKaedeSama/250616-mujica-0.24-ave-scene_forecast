# 重构前系统架构说明文档

## 1. 系统概述

本系统是一个基于深度学习的多源数据融合电网负荷预测系统，采用简单的**两层架构**设计：
- **前端视图层**：负责用户交互和结果展示
- **后端控制器与模型层**：负责业务逻辑处理和数据建模

系统支持负荷、光伏、风电预测，具备多种预测模式（日前预测、滚动预测、区间预测、概率预测）和天气场景感知的动态不确定性建模能力。

## 2. 整体系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    前端视图层 (Frontend)                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   用户界面层     │  │   交互控制层     │  │   数据展示层  │ │
│  │  (UI Components)│  │  (Event Handlers)│  │ (Visualization)│ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │ HTTP API
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  后端控制器与模型层 (Backend)                  │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   控制器模块                             │ │
│  │  ┌─────────────┐  ┌─────────────────────────────────────┐ │ │
│  │  │ Flask API   │  │      集成调度脚本                    │ │ │
│  │  │ (app.py)    │  │  (scripts/scene_forecasting.py)     │ │ │
│  │  └─────────────┘  └─────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│                              │                               │
│                              ▼                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                     模型模块                             │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────┐  │ │
│  │  │ 数据预处理   │ │ 数据管理     │ │ 模型构建与训练    │  │ │
│  │  │ 模块         │ │ 模块         │ │ 模块             │  │ │
│  │  └──────────────┘ └──────────────┘ └──────────────────┘  │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────┐  │ │
│  │  │ 预测执行     │ │ 场景分析     │ │ 文件系统存储      │  │ │
│  │  │ 模块         │ │ 模块         │ │ 模块             │  │ │
│  │  └──────────────┘ └──────────────┘ └──────────────────┘  │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 3. 前端视图层详细架构

### 3.1 技术栈
- **基础技术**：HTML5 + JavaScript + CSS3
- **框架**：React 18.x
- **构建工具**：Vite
- **样式框架**：TailwindCSS
- **图表库**：Chart.js, ECharts
- **HTTP客户端**：Fetch API

### 3.2 目录结构
```
frontend/
├── public/                    # 静态资源
│   ├── index.html            # HTML入口文件
│   └── fonts/                # 字体文件
├── src/                      # 源代码
│   ├── app.jsx              # 主应用组件
│   ├── main.jsx             # 应用入口
│   ├── components/          # React组件
│   │   ├── Header.jsx       # 页面头部组件
│   │   ├── ParameterSettings.jsx    # 参数配置组件
│   │   ├── RollingSettings.jsx      # 滚动预测设置
│   │   ├── IntervalSettings.jsx     # 区间预测设置
│   │   ├── TrainingSettings.jsx     # 训练设置组件
│   │   ├── MetricsCard.jsx          # 指标卡片组件
│   │   ├── HistoricalResultsTab.jsx # 历史结果查看
│   │   └── ScenarioAwareUncertaintyForecast.jsx # 场景感知预测
│   ├── styles/              # 样式文件
│   └── utils/               # 工具函数
│       ├── api.js           # API封装
│       ├── chartRenderers.js # 图表渲染
│       └── formatters.js    # 数据格式化
├── package.json             # 依赖配置
├── vite.config.js          # Vite配置
└── tailwind.config.js      # TailwindCSS配置
```

### 3.3 核心组件模块

#### 3.3.1 用户界面层 (UI Components)

**主应用组件 (app.jsx)**
- **输入**：用户交互事件、路由参数
- **输出**：渲染的页面DOM结构
- **主要功能**：
  - 应用状态管理
  - 路由控制
  - 全局主题管理
  - 组件协调

**参数配置组件 (ParameterSettings.jsx)**
- **输入**：默认参数配置、用户选择事件
- **输出**：参数配置对象、状态变更事件
- **主要功能**：
  - 省份选择控制
  - 预测类型选择
  - 日期范围设置
  - 历史数据天数配置
  - 置信水平设置

**预测设置组件群**
- **RollingSettings.jsx**：滚动预测参数设置
- **IntervalSettings.jsx**：区间预测参数设置
- **TrainingSettings.jsx**：模型训练参数设置
- **输入**：用户配置操作、默认参数
- **输出**：特定类型的参数配置对象
- **主要功能**：专门化的参数配置界面

#### 3.3.2 交互控制层 (Event Handlers)

**API交互模块 (utils/api.js)**
- **输入**：前端请求参数、配置对象
- **输出**：后端响应数据、错误信息
- **主要功能**：
  - HTTP请求封装
  - 错误处理
  - 请求超时控制
  - 响应数据格式化

**事件处理器**
- **输入**：用户交互事件（点击、输入、选择）
- **输出**：状态更新、API调用、页面跳转
- **主要功能**：
  - 表单提交处理
  - 参数验证
  - 异步操作管理
  - 用户反馈显示

#### 3.3.3 数据展示层 (Visualization)

**指标卡片组件 (MetricsCard.jsx)**
- **输入**：预测结果数据、指标配置
- **输出**：可视化图表、数据表格
- **主要功能**：
  - 预测精度指标展示
  - 时间序列图表渲染
  - 区间预测可视化
  - 不确定性分析展示

**图表渲染模块 (utils/chartRenderers.js)**
- **输入**：原始数据、图表配置
- **输出**：Chart.js/ECharts配置对象
- **主要功能**：
  - 时间序列图表配置
  - 区间预测阴影区域
  - 多系列数据对比
  - 交互式图表功能

### 3.4 用户交互流程

```
用户操作 → 参数配置 → 事件触发 → API调用 → 数据处理 → 结果展示
    ↓         ↓         ↓         ↓         ↓         ↓
 选择省份   设置参数   点击预测   发送请求   格式化数据  渲染图表
 选择类型   验证输入   提交表单   等待响应   错误处理   显示指标
 设置日期   状态更新   加载状态   解析JSON   缓存结果   用户反馈
```

## 4. 后端控制器与模型层详细架构

### 4.1 控制器模块

#### 4.1.1 Flask API服务 (app.py)

**基础架构**
- **输入**：HTTP请求（JSON格式参数）
- **输出**：HTTP响应（JSON格式结果）
- **主要功能**：
  - RESTful API端点管理
  - 请求参数验证
  - 跨域请求处理（CORS）
  - 缓存管理
  - 错误处理和日志记录

**核心API端点**

| 端点路径 | 方法 | 输入参数 | 输出数据 | 功能描述 |
|---------|------|---------|---------|---------|
| `/api/predict` | POST | province, forecastType, forecastDate, historicalDays | 预测结果JSON | 普通预测 |
| `/api/weather-forecast` | POST | province, forecastDate, weatherAware=true | 天气感知预测结果 | 天气感知预测 |
| `/api/interval-forecast` | POST | province, forecastType, startDate, endDate, confidenceLevel | 区间预测结果 | 区间预测 |
| `/api/train` | POST | province, forecastType, trainStart, trainEnd | 训练任务ID | 模型训练 |
| `/api/provinces` | GET | 无 | 省份列表 | 获取支持省份 |
| `/api/historical-results` | GET | modelType, predictionType, province | 历史结果列表 | 历史结果查询 |

**缓存管理系统**
- **输入**：请求参数哈希值、缓存策略配置
- **输出**：缓存命中结果或新计算结果
- **主要功能**：
  - 智能缓存键生成
  - 分类型缓存时间控制
  - 缓存命中统计
  - 强制刷新机制

**任务管理系统**
- **输入**：异步任务请求、任务配置参数
- **输出**：任务状态、执行结果
- **主要功能**：
  - 训练任务队列管理
  - 任务状态跟踪
  - 超时处理
  - 进程监控

#### 4.1.2 集成调度脚本 (scripts/scene_forecasting.py)

**核心功能**
- **输入**：命令行参数、配置文件
- **输出**：预测结果文件、执行日志
- **主要功能**：
  - 统一的预测入口
  - 多模块协调调度
  - 参数解析和验证
  - 结果文件管理

**命令行接口**
```bash
python scripts/scene_forecasting.py \
    --mode forecast \
    --province 上海 \
    --forecast_type load \
    --forecast_date 2024-06-10 \
    --day_ahead \
    --weather_aware
```

**参数处理模块**
- **输入**：命令行参数字符串
- **输出**：结构化参数对象
- **主要功能**：
  - 参数解析和类型转换
  - 默认值设置
  - 参数冲突检测
  - 路径规范化

### 4.2 模型模块

#### 4.2.1 数据预处理模块

**目录结构**
```
data_preprocess/
├── process_weather_data.py      # 天气数据处理
├── process_all_data.py          # 批量数据处理
└── 各省份天气数据目录/
    └── 月度NC文件
```

**天气数据处理 (data_preprocess/)**
- **输入**：NC格式气象文件、Excel格式负荷数据
- **输出**：标准化CSV时间序列文件
- **主要功能**：
  - NetCDF文件解析
  - 多气象要素提取（温度、湿度、风速、降水）
  - 区域网格数据聚合
  - 时间序列插值和对齐

**数据准备脚本 (scripts/data_preparation/)**
- **输入**：原始数据文件、处理配置
- **输出**：训练就绪的数据集
- **主要功能**：
  - 天气-负荷数据融合
  - 可再生能源数据处理
  - 数据质量检查和清洗

#### 4.2.2 数据管理模块 (data/)

**数据加载器 (data_loader.py)**
- **输入**：数据文件路径、加载配置
- **输出**：Pandas DataFrame对象
- **主要功能**：
  - 多格式数据文件读取
  - 数据类型自动识别
  - 缺失值处理
  - 数据范围验证

**数据集构建器 (dataset_builder.py)**
- **输入**：原始时间序列数据、特征工程配置
- **输出**：训练/测试数据集
- **主要功能**：
  - 时间窗口切分
  - 特征工程（滞后特征、时间特征、峰谷特征）
  - 数据标准化
  - 训练/验证/测试集划分

**数据文件组织**
```
data/
├── timeseries_load_*.csv        # 负荷数据
├── timeseries_pv_*.csv          # 光伏数据
├── timeseries_wind_*.csv        # 风电数据
├── timeseries_*_weather_*.csv   # 天气感知数据
└── *.db                         # SQLite数据库文件
```

#### 4.2.3 模型构建与训练模块 (models/)

**深度学习模型 (torch_models.py)**
- **输入**：模型配置参数、训练数据
- **输出**：训练好的PyTorch模型
- **主要功能**：
  - ConvTransformer架构实现
  - 多头注意力机制
  - 残差连接和层归一化
  - 自定义损失函数

**天气增强模型 (weather_enhanced_model.py)**
- **输入**：负荷数据 + 天气特征数据
- **输出**：天气感知预测模型
- **主要功能**：
  - 多模态特征融合
  - 天气场景编码
  - 动态权重调整
  - 不确定性量化

**统计模型 (statistical_models.py)**
- **输入**：时间序列数据、模型参数
- **输出**：统计预测模型
- **主要功能**：
  - ARIMA模型实现
  - 指数平滑模型
  - 季节性分解
  - 趋势分析

**训练脚本 (scripts/train/)**
```
scripts/train/
├── train_keras.py              # Keras模型训练
├── train_interval.py           # 区间预测模型训练
├── train_probabilistic.py     # 概率预测模型训练
└── train_weather_enhanced.py  # 天气增强模型训练
```

#### 4.2.4 预测执行模块 (scripts/forecast/)

**预测脚本组织**
```
scripts/forecast/
├── day_ahead_forecast.py                    # 日前预测
├── interval_forecast_fixed.py              # 区间预测
├── probabilistic_forecast.py               # 概率预测
├── scenario_aware_uncertainty_forecast.py  # 场景感知预测
└── weather_aware_forecast.py               # 天气感知预测
```

**日前预测 (day_ahead_forecast.py)**
- **输入**：历史数据、预测日期、模型文件
- **输出**：24小时点预测结果
- **主要功能**：
  - 模型加载和初始化
  - 输入数据预处理
  - 预测执行和后处理
  - 结果格式化和保存

**区间预测 (interval_forecast_fixed.py)**
- **输入**：历史数据、置信水平、预测范围
- **输出**：带置信区间的预测结果
- **主要功能**：
  - 分位数回归模型
  - 不确定性量化
  - 置信区间计算
  - 区间覆盖率验证

**场景感知预测 (scenario_aware_uncertainty_forecast.py)**
- **输入**：天气预报数据、历史场景库
- **输出**：场景分析 + 动态不确定性预测
- **主要功能**：
  - 天气场景识别（17种场景）
  - 动态不确定性调整
  - 场景匹配和相似度计算
  - 详细解释生成

#### 4.2.5 场景分析模块 (scripts/analysis/)

**天气场景聚类 (weather_scenario_clustering.py)**
- **输入**：全年天气-负荷数据
- **输出**：场景聚类结果、典型场景识别
- **主要功能**：
  - K-means聚类分析
  - 多维特征分析
  - 典型场景日识别
  - 极端天气统计

**场景汇总生成 (generate_scenario_summary.py)**
- **输入**：各省份场景分析结果
- **输出**：区域汇总报告、Excel数据表
- **主要功能**：
  - 跨省份数据汇总
  - 统计指标计算
  - 可视化图表生成
  - 运行建议生成

#### 4.2.6 文件系统存储模块

**模型文件存储**
```
models/
├── convtrans_weather/          # 天气感知模型
│   ├── load/省份/             # 负荷预测模型
│   ├── pv/省份/               # 光伏预测模型
│   └── wind/省份/             # 风电预测模型
├── convtrans_peak/            # 峰谷感知模型
└── scalers/                   # 数据标准化器
```

**结果文件存储**
```
results/
├── day_ahead/                 # 日前预测结果
├── weather_aware_day_ahead/   # 天气感知预测结果
├── interval_forecast/         # 区间预测结果
├── probabilistic/             # 概率预测结果
└── analysis/                  # 分析结果
```

**存储接口**
- **输入**：结果数据对象、存储路径配置
- **输出**：文件保存状态、访问路径
- **主要功能**：
  - JSON/CSV格式转换
  - 目录结构管理
  - 文件命名规范
  - 历史版本管理

## 5. 数据流转和交互模式

### 5.1 典型预测流程

```
1. 前端参数配置
   ├── 用户选择省份、预测类型、日期
   ├── 设置历史数据天数、置信水平
   └── 提交预测请求

2. API请求处理
   ├── Flask接收POST请求
   ├── 参数验证和缓存检查
   ├── 构建命令行参数
   └── 调用scene_forecasting.py

3. 集成脚本执行
   ├── 参数解析和路径构建
   ├── 数据加载和预处理
   ├── 模型加载和预测执行
   └── 结果保存和日志记录

4. 结果返回处理
   ├── 读取预测结果文件
   ├── 数据格式转换（CSV→JSON）
   ├── 添加元数据和统计信息
   └── HTTP响应返回

5. 前端结果展示
   ├── 解析响应数据
   ├── 生成图表配置
   ├── 渲染可视化组件
   └── 显示指标和分析
```

### 5.2 训练流程

```
1. 训练任务提交
   ├── 前端配置训练参数
   ├── API创建异步任务
   └── 返回任务ID

2. 后台训练执行
   ├── 数据准备和特征工程
   ├── 模型构建和参数初始化
   ├── 训练循环和验证
   └── 模型保存和评估

3. 状态监控
   ├── 定期查询训练状态
   ├── 更新进度和日志
   └── 完成通知
```

### 5.3 缓存机制

```
请求 → 缓存键生成 → 缓存查找 → 命中/未命中
  ↓         ↓         ↓         ↓
参数哈希   MD5计算   内存查询   返回结果/执行计算
配置合并   键前缀    过期检查   更新缓存
```

## 6. 系统边界和限制

### 6.1 模块边界问题

**控制器与模型层界限模糊**
- app.py既承担API控制又包含业务逻辑
- scene_forecasting.py作为集成脚本承担了过多职责
- 数据处理逻辑分散在多个模块中

**数据访问层缺失**
- 直接文件系统读写，缺乏统一的数据访问接口
- 数据格式转换逻辑散布在各个模块
- 缺乏数据一致性和事务管理

### 6.2 可维护性问题

**代码耦合度高**
- 前端直接调用后端脚本，缺乏抽象层
- 模型训练和预测逻辑混合
- 配置管理分散，难以统一维护

**扩展性限制**
- 新增预测类型需要修改多个模块
- 模型替换困难，接口不统一
- 缺乏插件化架构支持

### 6.3 技术债务

**性能问题**
- 同步处理模式，长时间任务阻塞
- 缓存策略简单，命中率有待提升
- 文件I/O操作频繁，缺乏优化

**稳定性问题**
- 错误处理不完善，异常传播链条长
- 资源管理不当，可能存在内存泄漏
- 中文路径兼容性问题

## 7. 重构建议

基于以上分析，建议采用DDD（领域驱动设计）和Clean Architecture（整洁架构）进行重构：

### 7.1 四层架构设计
- **用户接口层**：纯粹的UI和API接口
- **应用层**：业务流程编排和用例实现
- **领域层**：核心业务逻辑和规则
- **基础设施层**：数据持久化和外部服务

### 7.2 关键改进点
- 明确模块边界和职责分离
- 引入依赖注入和接口抽象
- 统一数据访问和事务管理
- 提升系统可测试性和可维护性

### 7.3 迁移策略
- 渐进式重构，保持功能连续性
- 核心领域逻辑优先迁移
- 建立完善的测试覆盖
- 统一配置和部署管理

---

**文档版本**：v1.0
**编写日期**：2024-12-09
**适用系统版本**：v0.24及之前版本 